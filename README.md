# Оптимизация API-сервиса с профилировкой

Этот проект демонстрирует оптимизацию простого HTTP API-сервиса путем профилирования и анализа производительности с использованием встроенных инструментов Go.

## Обзор задачи

Основная задача заключалась в оптимизации API-сервиса по CPU и памяти путем:
- Реализации профилирования с помощью `pprof` и `net/http/pprof`
- Использования инструментов бенчмаркинга, таких как `benchstat` и `go test -bench`
- Анализа трассировок для выявления узких мест

## Оптимизации и исправления

### 1. Исправление утечки памяти в In-Memory Cache

**Выявленная проблема:**
- Добавлен HTTP-сервер для профилирования в `main.go`
- Отчеты pprof показали рост HeapObjects со временем без освобождения памяти
- In-memory cache не имел очистки памяти, что рисковало крахом сервиса из-за нехватки памяти

**Реализованное решение:**
- Реализован механизм TTL (Time-To-Live), который запускается каждый час
- Автоматически удаляет заказы старше 1 часа из кэша

### 2. Профилирование CPU и оптимизация сериализации JSON

**Выявленная проблема:**
- Создан стресс-тест с помощью утилиты `wrk`
- Собран профили CPU и памяти:
  ```bash
  curl -o cpu.prof http://localhost:6060/debug/pprof/profile?seconds=30
  curl -o mem.prof http://localhost:6060/debug/pprof/heap
  ```
- Проанализированы профили с помощью `go tool`
- Анализ использования CPU показал:
  - Операции syscall были самыми высокими (нормально для веб-приложений из-за I/O сокетов)
  - На втором месте была сериализация/десериализация JSON из-за медленного `encoding/json`

**Реализованное решение:**
- Заменена стандартная библиотека `encoding/json` на `github.com/goccy/go-json`
- Улучшена производительность для сериализации больших объектов данных заказов

### 3. Бенчмаркинг и анализ трассировок

**Выполненный анализ:**
- Использован `benchstat` для измерения результатов производительности
- Проанализированы графики `go tool trace`
- Подтвержден рост аллокаций в куче из-за in-memory cache (как было выявлено ранее)

## История профилирования

Процесс оптимизации документирован через коммиты git, показывающие эволюцию улучшений производительности и примененных исправлений в кодовой базе.

## Используемые инструменты

- `net/http/pprof` для конечных точек профилирования
- `go tool pprof` для анализа профилей
- `benchstat` для сравнения бенчмарков
- `go tool trace` для трассировки выполнения
- `wrk` для стресс-тестирования
